<!-- <html>
	<head>
	</head>
	<body>
	</body>
</html> -->

<!-- {% verbatim myblock %} -->
<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>NAPToken Test</title>

  <!-- web3 -->
  <script src="./web3.min.js"></script>
  <script language="javascript" type="text/javascript" src="./NAPToken_ABI.js"></script>
  <script language="javascript" type="text/javascript" src="./NAP_0_MVP_ABI.js"></script>

  <!-- vue.js -->
  <!-- å¼€å‘ç¯å¢ƒç‰ˆæœ¬ï¼ŒåŒ…å«äº†æœ‰å¸®åŠ©çš„å‘½ä»¤è¡Œè­¦å‘Š -->
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <!-- ç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬ï¼Œä¼˜åŒ–äº†å°ºå¯¸å’Œé€Ÿåº¦ -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/vue"></script> -->

  <!-- Pure -->
  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/base-min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- å¼ºåˆ¶åˆ·æ–°å…é—ç•™ -->
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="Cache-Control" content="no-cache, must-revalidate">
  <meta http-equiv="expires" content="0">

</head>
<style scoped>
  .button-success,
  .button-error,
  .button-warning,
  .button-secondary {
    color: white;
    border-radius: 4px;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
  }

  .button-success {
    background: rgb(28, 184, 65);
    /* this is a green */
  }

  .button-error {
    background: rgb(202, 60, 60);
    /* this is a maroon */
  }

  .button-warning {
    background: rgb(223, 117, 20);
    /* this is an orange */
  }

  .button-secondary {
    background: rgb(66, 184, 221);
    /* this is a light blue */
  }
</style>

<body>
  <div id="app">
    Token:0xF7Ca71B734e47A322362bA3F411DD20EDC415dfd | DEO-MVP:0x58c6f695bed49aD756fF1cf1B01f84DAC95A43B7<br>
    å½“å‰åŒºå—é«˜åº¦ï¼š{{blockHeight}}
    <div class="pure-g">
      <div class="pure-u-1 pure-u-md-1-1"> â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” </div>
    </div>
    <!-- <form class="pure-form"> -->
    <div class="pure-menu pure-menu-horizontal">
      <button class="pure-button pure-button-active" @click="RefreshFunds()">ğŸ”„{{addressNow}}</button>
      <button class="pure-button pure-button-active">NAPs In MVP : {{MVP_NapsF}}</button>
    </div>
    <div class="pure-menu pure-menu-horizontal">
      <a class="pure-menu-heading pure-menu-link pure-menu-selected">NAP Funds:</a>
      <ul class="pure-menu-list">
        <li class="pure-menu-item"><a class="pure-menu-link" @click="v_Naps=walletBalance">{{walletBalanceF}} NAP in
            Wallet</a></li>

        <button class="button-warning pure-button" @click="withdrawFromMvp()">â¬…æå–</button>
        <input type="text" placeholder="NAPS Value" v-model='v_Naps'>
        <button class="button-secondary pure-button" @click="depositToMvp()">å……å€¼â¡</button>
        <li class="pure-menu-item"><a class="pure-menu-link" @click="v_Naps=mvp0Balance">{{mvp0BalanceF}} NAP in
            MVP_Contract</a></li>
        <!-- <li class="pure-menu-item"><a href="#" class="pure-menu-link">Sports</a></li>
        <li class="pure-menu-item"><a href="#" class="pure-menu-link">Finance</a></li> -->
      </ul>
    </div>
    <!-- </form> -->
    <div class="pure-g">
      <div class="pure-u-1 pure-u-md-1-1"> â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” </div>
    </div>
    <div class="pure-menu pure-menu-horizontal">
      <!-- <form class="pure-form"> -->
      <a class="pure-menu-heading pure-menu-link pure-menu-selected"
        @click="getGamesIDRLByState(filterState,0,10)">ğŸ”„Games:</a>
      <!-- state,start,limit -->
      <ul class="pure-menu-list">
        <label>JoinFee</label>
        <input type="text" placeholder="joinFee (ether)" v-model='joinFee'>
        <label>waitBlocks</label>
        <input type="text" placeholder="waitBlocks" v-model='waitBlocks'>
        <button class="button-success pure-button" @click="CreateAndJoinGame()">CreateAndJoinTheGame</button>
        <!-- <li class="pure-menu-item"><a class="pure-menu-link"></a></li> -->
      </ul>
      <!-- </form> -->
    </div>
    <div class="pure-g">
      <div class="pure-u-1 pure-u-md-1-1"> â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” </div>
    </div>
    <div>
      Games lobby:
      <button :class="[lobbyFilterState == 0 ? 'pure-button-active':'',cssList[0],'pure-button']"
        @click="(lobbyFilterState = 0) & (getGamesIDRLByState(lobbyFilterState,0,10))">Joining</button>

      <button :class="[lobbyFilterState == 4 ? 'pure-button-active':'',cssList[4],'pure-button']"
        @click="(lobbyFilterState = 4) & (getGamesIDRLByState(lobbyFilterState,0,10))">Finished</button>


    </div>

    <!-- lobby -->
    <div style="width: auto;">
      <button v-for='gameData in lobbyGameDatas' :class="[cssList[lobbyFilterState],'pure-button']"
        @click="gameInteraction(gameData.GameId,gameData.joinFee,gameData.state,gameData.myUintInTheGame)"
        style="margin:5px;width: 500px;">
        <div class="pure-g">
          <!-- <div class="pure-u-1-1">
            <p>Creater&Joined:{{gameData.GameId}}</p>
          </div> -->
          <div class="pure-u-1-2">
            <p>GameID:{{gameData.GameId}}</p>
          </div>
          <div class="pure-u-1-2">
            <p>I in Game:{{gameData.myUintInTheGame}}</p>
          </div>
          <div class="pure-u-2-5">
            <p>waitBlocks:{{gameData.waitBlocks}}</p>
          </div>
          <div class="pure-u-3-5">
            <p>expire@:{{gameData.expireBlock}} blocks</p>
          </div>
          <div class="pure-u-1-1">
            <p>JoinFee:{{w3.utils.fromWei(gameData.joinFee, 'ether')}}</p>
          </div>
        </div>
      </button>
    </div>
    <div class="pure-g">
      <div class="pure-u-1 pure-u-md-1-1"> â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” </div>
    </div>
    <div class="pure-menu pure-menu-horizontal">
      é€‰æ‹©ç­–ç•¥ï¼š
      <ul class="pure-menu-list">
        <li class="pure-menu-item" @click='strategy=1'><a href="#" class="pure-menu-link">ğŸ”º</a></li>
        >
        <li class="pure-menu-item" @click='strategy=2'><a href="#" class="pure-menu-link">ğŸ”¹</a></li>
        >
        <li class="pure-menu-item" @click='strategy=3'><a href="#" class="pure-menu-link">âšª</a></li>
        > ğŸ”ºâ€¦â€¦

      </ul>
      | åŠ å¯†ç”¨éšæœºç†µæº:
      <input type="text" placeholder="entropy" v-model='entropy'>
    </div>
    <div>
      My Games:
      <button :class="[MyFilterState == 1 ? 'pure-button-active':'',cssList[1],'pure-button']"
        @click="(MyFilterState = 1) & (getMyGamesIDRLByState(MyFilterState,0,10))">WaitInitiative</button>
      <button :class="[MyFilterState == 2 ? 'pure-button-active':'',cssList[2],'pure-button']"
        @click="(MyFilterState = 2) & (getMyGamesIDRLByState(MyFilterState,0,10))">WaitGote</button>
      <button :class="[MyFilterState == 3 ? 'pure-button-active':'',cssList[3],'pure-button']"
        @click="(MyFilterState = 3) & (getMyGamesIDRLByState(MyFilterState,0,10))">WaitCombat</button>
    </div>

    <!-- My -->
    <div style="width: auto;">
      <button v-for='gameData in myGameDatas' :class="[cssList[MyFilterState],'pure-button']"
        @click="gameInteraction(gameData.GameId,gameData.joinFee,gameData.state,gameData.myUintInTheGame)"
        style="margin:5px;width:500px">
        <div class="pure-g">
          <!-- <div class="pure-u-1-1">
            <p>Creater&Joined:{{gameData.GameId}}</p>
          </div> -->
          <div class="pure-u-1-2">
            <p>GameID:{{gameData.GameId}}</p>
          </div>
          <div class="pure-u-1-2">
            <p>I in Game:{{gameData.myUintInTheGame}}</p>
          </div>
          <div class="pure-u-2-5">
            <p>waitBlocks:{{gameData.waitBlocks}}</p>
          </div>
          <div class="pure-u-3-5">
            <p>expire@:{{gameData.expireBlock}} blocks</p>
          </div>
          <div class="pure-u-1-1">
            <p>JoinFee:{{w3.utils.fromWei(gameData.joinFee, 'ether')}}</p>
          </div>

        </div>
      </button>
    </div>


    <!-- {{ message }} -->
  </div>


  <script>
    var NAPTokenAddress = "0xF7Ca71B734e47A322362bA3F411DD20EDC415dfd";
    var MVPAddress = "0x58c6f695bed49aD756fF1cf1B01f84DAC95A43B7";
    self.setTimeout("app.RefreshFunds()", 1000);
    self.setInterval("app.RefreshFunds()", 10000);
    
    
    web3js = new Web3(web3.currentProvider);
    NAPTokens = new web3js.eth.Contract(NAPTokenABI, NAPTokenAddress);
    MVP = new web3js.eth.Contract(MVP_0_ABI, MVPAddress);
    
    ethereum.enable();
    window.ethereum; 
    web3js.eth.getAccounts().then(function (accounts) {
      
      console.log(accounts);
    });
    ethereum.on('accountsChanged', function (accounts) {
      
      app.RefreshFunds();
      app.myGameDatas = [];
      app.lobbyGameDatas = [];
    })
    var STORAGE_KEY = 'Nash Protocol-MVP_0';
    var NAPStorage = {
      fetch: function () {
        
        var games = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        
        
        
        
        
        return games
      },
      save: function (games) {
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(games))
      }
    };

    var app = new Vue({
      el: '#app',
      data: {
        
        w3: web3js = new Web3(web3.currentProvider),
        blockHeight: 0,
        addressNow: '0x0000000000000000000000000000000000000000',
        walletBalance: 0,
        walletBalanceF: '',
        mvp0Balance: 0,
        mvp0BalanceF: '',
        v_Naps: 0,
        MVP_Naps: 0,
        MVP_NapsF: 0,
        
        joinFee: '0.1',
        waitBlocks: '100',
        lobbyFilterState: 0,
        MyFilterState: 0,
        lobbyGameDatas: [],
        myGameDatas: [],
        cssList: ['button-success', 'button-error', 'button-warning', 'button-secondary', ''],
        strategy: 0,
        entropy: 'The external input that can be obtained from a Web browser as a random signal entropy value.',
        encryptedEntropy: '',
        localGames: NAPStorage.fetch(),
        finallyRst:''

      },
      
      

      
      methods: {
        
        
        CreateAndJoinGame() {
          MVP.methods.createGameAndJoin(this.waitBlocks).send({
            from: web3.eth.defaultAccount,
            value: web3js.utils.toWei(this.joinFee)
          }).then((rst) => {
            console.log('rst', rst);
            this.RefreshFunds();
          });
        },
        getGamesIDRLByState(_state, _startID, _limit) {
          MVP.methods.getGamesIDRLByState(_state, _startID, _limit).call({ from: web3.eth.defaultAccount }).then((GameIDRLs) => {
            if (_state == 0 | _state == 4) {
              this.lobbyGameDatas = [];
            }
            else {
              this.myGameDatas = [];
            }
            
            
            for (let i = 0; GameIDRLs[0][i] != 0 | i == 0; i++) {
              
              MVP.methods.Games(GameIDRLs[0][i]).call().then((rst2) => {
                
                if (_state == rst2.state) {
                  rst2.GameId = GameIDRLs[0][i];
                  rst2.myUintInTheGame = GameIDRLs[1][i];
                  if (_state == 0 | _state == 4) {
                    this.lobbyGameDatas.push(rst2);
                  }
                  else {
                    this.myGameDatas.push(rst2);
                  }
                }

              })

            }
            console.log('lobbyGameDatas', this.lobbyGameDatas);
          });
        },
        getMyGamesIDRLByState(_state, _startID, _limit) {
          MVP.methods.getMyGamesIDRLByState(_state, _startID, _limit).call({ from: web3.eth.defaultAccount }).then((GameIDRLs) => {
            console.log('getMyGamesIDRLByState', GameIDRLs);
            if (_state == 0 | _state == 4) {
              this.lobbyGameDatas = [];
            }
            else {
              this.myGameDatas = [];
            }
            
            
            for (let i = 0; GameIDRLs[0][i] != 0 | i == 0; i++) {
              
              MVP.methods.Games(GameIDRLs[0][i]).call().then((rst2) => {
                
                if (_state == rst2.state) {
                  rst2.GameId = GameIDRLs[0][i];
                  rst2.myUintInTheGame = GameIDRLs[1][i];
                  if (_state == 0 | _state == 4) {
                    this.lobbyGameDatas.push(rst2);
                  }
                  else {
                    this.myGameDatas.push(rst2);
                  }
                }

              })

            }
            
          });
        },
        gameInteraction(_gameID, _joinFee, _gameState, _myUintInGame) {
          
          switch (parseInt(_gameState)) {
            case 0: 
              
              if (_myUintInGame == 255) {
                alert('ä½ æ˜¯è¯¥æ¸¸æˆçš„åˆ›å»ºè€…ï¼Œåˆ«é—¹ã€‚æ™ºèƒ½åˆçº¦ä¹Ÿåšäº†é™åˆ¶ä¸èƒ½255çŠ¶æ€çš„é‡å¤åŠ å…¥ï¼Œå› ä¸ºå±äºå·²ç»åŠ å…¥ã€‚')
                break;
              }
              else if (_myUintInGame == 0) {
                console.log(_gameState);
                MVP.methods.joinGame(_gameID).send({ from: web3.eth.defaultAccount, value: _joinFee });
                MVP.getPastEvents('GameStateUpdated', { filter: { Player: web3.eth.defaultAccount }, fromBlock: 0 }).then((rst) => { console.log(rst) });
                break;
              }


            case 1: 
              
              
              
              if (this.strategy == 0) {
                alert('è¯·å…ˆé€‰æ‹©ç­–ç•¥')
                break;
              }
              if (this.entropy == '') {
                alert('è¯·è¾“å…¥éšæœºåŠ å¯†ç†µ')
                break;
              }
              cfm = confirm(`æ‚¨çš„ç­–ç•¥ï¼š${this.strategy},åŠ å¯†ç†µåŸæ–‡ï¼š${this.entropy}ã€‚è¯·é—®æ˜¯å¦è¦æäº¤å‘¢ï¼Ÿï¼ˆæ­¤å¤„åªä¾›demoå±•ç¤ºï¼Œæ­£å¼ç‰ˆä¸ä¼šå‡ºç°,å¹¶ä¸”å°†ä½¿ç”¨é¼ æ ‡å’Œ3Då¤æ‚åœºæ™¯ç”Ÿæˆé•¿åº¦ä¸å°äº64çš„ASCIIå­—ç¬¦èŒƒå›´çš„ç†µåŸæ–‡ã€‚ï¼‰`)
              if (cfm == false) break;
              let encryptedEntropy = web3js.utils.keccak256(this.entropy).substring(2);
              let strategy = this.strategy;
              let hash = this.encryption(encryptedEntropy, strategy);
              console.log(hash);
              MVP.methods.setInitiativeAction(_gameID, hash).send({ from: web3.eth.defaultAccount }).then((rst) => {
                this.localGames[_gameID] = { encryptedEntropy, strategy }
                NAPStorage.save(this.localGames);
                console.log(rst);
                alert('å…ˆæ‰‹ç­–ç•¥Hashæäº¤æˆåŠŸï¼š', hash);
              });
              this.strategy = 0;
              
              break;
            case 2: 
              
              _myUintInGame == 201 ? alert('æ‚¨å·²ç»æ˜¯å…ˆæ‰‹äº†ï¼Œå¹¶æäº¤äº†hashï¼Œç­‰å¾…å¯¹æ–¹å‘å‡ºç­–ç•¥å§') : 
                (this.strategy == 0 ? alert('è¯·å…ˆé€‰æ‹©ç­–ç•¥') :
                  MVP.methods.setGoteAction(_gameID, this.strategy).send({ from: web3.eth.defaultAccount }).then((rst) => {
                    console.log(rst);
                    alert('åæ‰‹ç­–ç•¥æ˜æ–‡æäº¤æˆåŠŸ');
                  })
                );
              break;
            case 3: 
              
              if (_myUintInGame == 201) {
                let gls = this.localGames[_gameID];
                
                
                
                

                MVP.getPastEvents('GameStateUpdated', { filter: { GameID: _gameID }, fromBlock: 0 }).then((rst) => {
                  this.opponent = rst.pop().returnValues.Player;
                  
                  console.log(_gameID,typeof(gls.encryptedEntropy),gls.encryptedEntropy,typeof(gls.strategy),gls.strategy,typeof(this.opponent),this.opponent)
                  MVP.methods.makeCombat(_gameID, gls.encryptedEntropy, gls.strategy, this.opponent).send({ from: web3.eth.defaultAccount }).then((rst) => {
                    console.log(rst);
                    MVP.getPastEvents('GameOver', { filter: { GameID: 3, nowState: 3 }, fromBlock: 0 }).then((rst)=>{
                      console.log(rst);
                      this.finallyRst = rst
                      console.log('æ¸¸æˆID',this.finallyRst[0].returnValues.GameID)
                      console.log('èµ¢å®¶',this.finallyRst[0].returnValues.Winner)
                      console.log('å¥–é‡‘',this.finallyRst[0].returnValues.prize)
                      
                      alert(`GameID=${this.finallyRst[0].returnValues.GameID} | èµ¢å®¶=${this.finallyRst[0].returnValues.Winner},
                      å¥–é‡‘=${this.finallyRst[0].returnValues.prize} wei`);
                    })
                  });
                });

                
              }
              else alert(`æ‚¨å·²ç»æ˜¯è¯¥å¯¹å±€çš„åæ‰‹ï¼Œå·²ç»æäº¤äº†æ˜æ–‡ç­–ç•¥=${_myUintInGame}ï¼Œç­‰å¾…å…ˆæ‰‹å†³èƒœå§!`);

              break;
            case 4: 
              
              alert('è¿™æ˜¯å·²ç»ç»“æŸäº†çš„æ¸¸æˆï¼Œä¹‹åå¼€æ”¾é€šè¿‡EventsæŸ¥è¯¢æ¸¸æˆå¯¹æˆ˜åŒæ–¹è®°å½•ã€‚')
              break;
          }
        },
        encryption(enetp, stg) {
          

          
          return web3js.utils.keccak256(web3js.eth.abi.encodeParameters(['string', 'uint32'], [enetp, stg]));
        },
        getEvents() {
          
          
          
          
          
          
          //
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          MVP.getPastEvents('newGameCreated', { filter: { waitBlocks: [0, 100] }, fromBlock: 0 }).then((rst) => { console.log(rst) });
          NAPTokens.getPastEvents('Transfer', { filter: { from: web3.eth.defaultAccount }, fromBlock: 0 }).then((rst) => { console.log(rst) });

        },

        
        RefreshFunds() {
          this.getWalletBalance();
          this.getMyMvp0Balance();
          this.getMvp0Balance();
          web3js.eth.getBlockNumber().then((rst) => { this.blockHeight = rst })
          this.addressNow = web3.eth.defaultAccount;
        },
        getWalletBalance() {
          NAPTokens.methods.balanceOf(web3.eth.defaultAccount).call().then((result) => {
            this.walletBalance = web3js.utils.fromWei(result, 'ether');
            this.walletBalanceF = parseFloat(this.walletBalance).toLocaleString();
          });
        },
        getMyMvp0Balance() {
          MVP.methods.NAPsInBankBalanceOf(web3.eth.defaultAccount).call().then((result) => {
            this.mvp0Balance = web3js.utils.fromWei(result, 'ether');
            this.mvp0BalanceF = parseFloat(this.mvp0Balance).toLocaleString();
          });
        },
        getMvp0Balance() {
          NAPTokens.methods.balanceOf(MVPAddress).call().then((rst) => {
            this.MVP_Naps = web3js.utils.fromWei(rst, 'ether');
            this.MVP_NapsF = parseFloat(this.MVP_Naps).toLocaleString();
          })
        },
        numToLocaleString(_num) {
          return num.toLocaleString();
        },
        depositToMvp() {
          NAPTokens.methods.transfer(MVPAddress, web3.toWei(this.v_Naps, "ether")).send({ from: web3.eth.defaultAccount }).then(() => {
            this.RefreshFunds();
          });

        },
        withdrawFromMvp() {
          MVP.methods.withdrawNAP(web3.toWei(this.v_Naps, "ether")).send({ from: web3.eth.defaultAccount }).then(() => {
            this.RefreshFunds();
          });
        },
        
        
        
        transfer() {
          NAPTokens.methods.transfer("0x54a6ca501D8E867cA21509f1CFf49Ff739B6137e", web3.toWei("1234343", "ether")).send({ from: web3.eth.defaultAccount });
        },
        
        
        
      }
    })
    


  </script>

</body>

</html>


<!-- {% endverbatim myblock %} -->
